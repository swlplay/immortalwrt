
name: Monitor and Build ImmortalWrt (x86_64 Master)

on:
  # 定时触发：每周二18点检查更新（UTC时间）
  schedule:
    - cron: '0 18 * * 2'
  
  # 代码推送触发：推送到 master 分支时触发
  push:
    branches: [ master ]
  
  # Pull Request 触发：针对 master 分支的 PR 时触发
  pull_request:
    branches: [ master ]
  
  # 手动触发：允许在网页上手动触发
  workflow_dispatch:

env:
  TARGET: x86
  SUBTARGET: 64
  WORKING_DIRECTORY: immortalwrt-x86
  CONFIG_HISTORY_DIR: config-x86-64-history  # 新增配置历史目录变量

jobs:
  check-and-build:
    runs-on: ubuntu-22.04
    container:
      image: debian:11-slim
      
    steps:
    - name: Install dependencies
      shell: bash
      run: |
        apt-get update
        apt-get full-upgrade -y
        apt-get install -y bash git curl ca-certificates  # 确保安装bash
        apt-get install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
          g++-multilib gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
          libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncurses-dev libpython3-dev \
          libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
          ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
          python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
          upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
        
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # 确保拉取所有分支和历史，以便后续推送
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clone ImmortalWrt master branch
      shell: bash
      run: |
        git clone -b master --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt $WORKING_DIRECTORY

    - name: Check for updates in master branch
      id: check-update
      shell: bash
      run: |
        cd "$WORKING_DIRECTORY"
        LATEST_COMMIT_HASH=$(git rev-parse HEAD)
        echo "latest_commit=$LATEST_COMMIT_HASH" >> $GITHUB_OUTPUT
        echo "CURRENT_HASH=$LATEST_COMMIT_HASH" >> $GITHUB_ENV
        echo "Latest commit hash: $LATEST_COMMIT_HASH"

    - name: Restore cached commit hash
      id: cache-hash
      uses: actions/cache@v4
      with:
        path: .cache
        key: immortalwrt-${{ env.CURRENT_HASH }}
        restore-keys: |
          immortalwrt-

    - name: Build ImmortalWrt if source updated
      shell: bash
      if: steps.cache-hash.outputs.cache-hit != 'true'
      run: |
        set -ex
        cd $GITHUB_WORKSPACE/immortalwrt-x86/
        echo "FORCE_UNSAFE_CONFIGURE=1" >> $GITHUB_ENV
        
        # 初始化空间使用记录
        echo "初始状态:" > space_usage.log
        du -sh . | grep -oE '[0-9.]+[A-Z]' >> space_usage.log

        echo "开始更新feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        
        echo "配置编译目标为 $TARGET/$SUBTARGET..."
        # 复制预定义的配置
        cd $GITHUB_WORKSPACE/config-x86-64-history/
        ls -la
        cp .config $GITHUB_WORKSPACE/immortalwrt-x86/.config
        cd $GITHUB_WORKSPACE/immortalwrt-x86/
        ls -la
    - name: Build Tools
      run: |
        echo "开始编译..."
        # 先尝试多线程编译，失败后使用单线程详细输出
        timeout 14400 make -j1 || {
          echo "多线程编译失败或超时，尝试单线程编译..."
          make -j1 V=s
        }
        
        echo "编译完成！"

        
        # 创建包索引
        make package/index
        
        echo "最终组装后:" >> space_usage.log
        du -sh . | grep -oE '[0-9.]+[A-Z]' >> space_usage.log
        
        # 最终清理（保留产物）
        rm -rf build_dir/* staging_dir/* tmp/*
        # 保留 bin/ 目录和 dl/ 缓存
        
        echo "最终清理后:" >> space_usage.log
        du -sh . | grep -oE '[0-9.]+[A-Z]' >> space_usage.log
    
 
    - name: Generate and save config files
      shell: bash
      if: steps.cache-hash.outputs.cache-hit != 'true'
      run: |
        cd "$WORKING_DIRECTORY"
        
        # 确保配置目录存在（使用新的目录名）
        mkdir -p $GITHUB_WORKSPACE/$CONFIG_HISTORY_DIR
        
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # 保存带时间戳的配置文件到新目录
        cp .config $GITHUB_WORKSPACE/$CONFIG_HISTORY_DIR/config-$TIMESTAMP.txt
        
        # 保存最新配置文件到构建产物目录
        mkdir -p bin/targets/$TARGET/$SUBTARGET/
        cp .config bin/targets/$TARGET/$SUBTARGET/config-latest.txt
        
        # 为单独配置文件构建物创建目录
        mkdir -p ../config-artifacts
        cp .config ../config-artifacts/immortalwrt-x86-64-config.txt
        
        echo "配置文件已保存：$CONFIG_HISTORY_DIR/config-$TIMESTAMP.txt"
        
    - name: Clean up old configs (keep last 20)
      shell: bash
      if: steps.cache-hash.outputs.cache-hit != 'true'
      run: |
        cd $CONFIG_HISTORY_DIR
        ls -la
        
        CONFIG_COUNT=$(ls -1 config-*.txt 2>/dev/null | wc -l)
        echo "当前配置文件数量: $CONFIG_COUNT"
        
        if [ $CONFIG_COUNT -gt 20 ]; then
          ls -1t config-*.txt | tail -n +21 | xargs -r rm -f
          echo "已清理旧配置文件，保留最新的20个"
          echo "删除了 $((CONFIG_COUNT - 20)) 个旧配置文件"
        else
          echo "配置文件数量不足20个（当前 $CONFIG_COUNT 个），跳过清理"
        fi        
    
    - name: Commit config files to repository
      shell: bash
      if: steps.cache-hash.outputs.cache-hit != 'true'
      run: |
        # 切换回仓库根目录
        cd "$GITHUB_WORKSPACE"
        echo "工作目录内容:"
        ls -la
       
        # 添加当前工作目录为安全目录
        git config --global --add safe.directory "$GITHUB_WORKSPACE"
        git config --global --add safe.directory "$GITHUB_WORKSPACE/.git"
        
        # 配置 Git
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
        
        # 添加配置目录（使用新的目录名）
        git add "$CONFIG_HISTORY_DIR/"
        
        # 只在有变化时提交
        if git diff --staged --quiet; then
          echo "配置文件无变化，跳过提交"
        else
          git commit -m "Update ImmortalWrt configuration history [skip ci]"
          # 使用 token 推送
          git push "https://$GH_TOKEN@github.com/${{ github.repository }}.git" HEAD:${{ github.ref }}
          echo "配置文件已提交到仓库的 $CONFIG_HISTORY_DIR 目录"
        fi  
        
    - name: Save build cache
      shell: bash
      if: steps.cache-hash.outputs.cache-hit != 'true'
      run: |
        # 创建缓存目录
        mkdir -p .cache
        echo "Build completed for commit: ${{ env.CURRENT_HASH }}" > .cache/build-info.txt
        echo "构建完成时间: $(date)" >> .cache/build-info.txt

    - name: Upload build artifacts (固件和配置)
      if: steps.cache-hash.outputs.cache-hit != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-x86-64-images
        path: ${{ env.WORKING_DIRECTORY }}/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*
        retention-days: 7
        if-no-files-found: error

    - name: Upload config artifacts (单独配置文件)
      if: steps.cache-hash.outputs.cache-hit != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-x86-64-config
        path: config-artifacts/
        retention-days: 30
        if-no-files-found: error

    - name: Build skipped due to cache
      shell: bash
      if: steps.cache-hash.outputs.cache-hit == 'true'
      run: |
        echo "构建已跳过 - 提交 ${{ env.CURRENT_HASH }} 之前已经构建过"
        echo "如需强制重新构建，请删除缓存或等待新的提交"
